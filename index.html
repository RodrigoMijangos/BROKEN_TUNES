<!-- index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BROKEN TUNES</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* Tema inspirado en layouts de servicios de streaming (colores y sensación, sin assets ni marcas) */
    :root{
      --bg:#121212;
      --panel:#181818;
      --muted:#b3b3b3;
      --accent:#1db954; /* verde similar al que usan servicios de streaming */
      --card:#202020;
      --glass: rgba(255,255,255,0.04);
      --radius:12px;
      --gap:14px;
    }

    html,body{
      height:100%;
      margin:0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg,#0f0f0f 0%, #151515 100%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
    }

    .app {
      max-width:1100px;
      margin:28px auto 120px;
      padding:24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }

    header.top {
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:20px;
    }

    .logo {
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo .mark{
      width:44px;
      height:44px;
      background:linear-gradient(135deg, var(--accent), #1ed760);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#072;
      box-shadow: 0 2px 8px rgba(29,185,84,0.12) inset;
      transform: rotate(-10deg);
    }
    .logo h1{
      margin:0;
      font-size:20px;
      letter-spacing:0.6px;
    }
    .subtitle { color:var(--muted); font-size:13px; margin-top:4px; }

    .top-right {
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* Login box */
    #login {
      background: var(--glass);
      border-radius:10px;
      padding:10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    #login input {
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      padding:8px 10px;
      color:var(--muted);
      border-radius:8px;
      width:140px;
      outline:none;
    }
    #login button{
      background:var(--accent);
      color:#061206;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }

    main.grid {
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:20px;
    }

    /* Lista de canciones */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:16px;
    }

    .list-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .list-header h3 { margin:0; font-size:16px; }
    .list-header small { color:var(--muted); }

    #songs {
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }

    .song {
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:10px;
      transition: transform .12s ease, background .12s ease;
    }
    .song:hover{
      transform: translateY(-3px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }

    .art {
      width:56px;
      height:56px;
      background:linear-gradient(135deg,#2a2a2a,#111);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      flex-shrink:0;
    }

    .meta {
      flex:1;
      min-width:0;
    }
    .meta .title { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .artist { color:var(--muted); font-size:13px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .controls {
      display:flex;
      gap:8px;
      align-items:center;
      margin-left:6px;
    }

    .playbtn, .backupbtn {
      border: none;
      padding:8px 10px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      color: #fff;
      background: rgba(255,255,255,0.06);
    }
    .playbtn {
      background: linear-gradient(90deg, var(--accent), #1ed760);
      color: #041204;
      box-shadow: 0 4px 12px rgba(29,185,84,0.12);
    }
    .backupbtn {
      background: transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
    }

    /* Panel derecho - Backups y detalles */
    .right-col {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    #backups {
      max-height:360px;
      overflow:auto;
      padding-right:6px;
    }

    /* Player bar fijo en la parte inferior */
    .player-bar {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background: linear-gradient(180deg, rgba(20,20,20,0.98), rgba(10,10,10,0.95));
      border-top:1px solid rgba(255,255,255,0.03);
      padding:12px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      z-index:9999;
      box-shadow: 0 -6px 30px rgba(0,0,0,0.6);
    }
    .player-bar .left {
      display:flex;
      gap:12px;
      align-items:center;
      min-width:240px;
    }
    .player-bar .track-info { color:var(--muted); font-size:13px; }
    .player-bar .center { flex:1; display:flex; align-items:center; gap:12px; justify-content:center; }
    .player-bar .right { display:flex; gap:12px; align-items:center; }

    /* controles de velocidad */
    #speed {
      width:180px;
    }
    #speedVal { color:var(--muted); margin-left:8px; font-weight:700; }

    /* pequeños ajustes responsivos */
    @media (max-width:900px){
      main.grid { grid-template-columns: 1fr; }
      .app { margin-bottom:180px; }
      #login input { width:110px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="top">
      <div class="logo">
        <div class="mark">BT</div>
        <div>
          <h1>BROKEN TUNES</h1>
          <div class="subtitle">Tu música local — prueba rápida</div>
        </div>
      </div>

      <div class="top-right">
        <div id="login">
          <input id="u" placeholder="username" value="admin" aria-label="username">
          <input id="p" placeholder="password" value="1234" type="password" aria-label="password">
          <button onclick="doLogin()">Login</button>
          <div id="login-res" style="margin-left:8px;color:var(--muted);font-size:13px"></div>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="panel">
        <div class="list-header">
          <h3>Tu Biblioteca</h3>
          <small>Listado de canciones</small>
        </div>
        <div id="songs">Cargando...</div>
      </section>

      <aside class="right-col">
        <div class="panel">
          <div class="list-header">
            <h3>Backups</h3>
            <small>Copias guardadas</small>
          </div>
          <div id="backups">Cargando backups...</div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Control de reproducción</strong><br>
              <small style="color:var(--muted)">Ajusta velocidad de reproducción</small>
            </div>
            <div style="color:var(--muted);font-size:13px">Velocidad <span id="speedVal">1.0</span>x</div>
          </div>
          <div style="margin-top:12px;display:flex;align-items:center;gap:12px">
            <input id="speed" type="range" min="0.5" max="2.0" step="0.1" value="1" oninput="setSpeed(this.value)">
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Player fijo -->
  <div class="player-bar" role="region" aria-label="player controls">
    <div class="left">
      <div class="art" id="now-art">♪</div>
      <div class="track-info">
        <div id="now-title">Nada reproduciéndose</div>
        <div id="now-artist" style="color:var(--muted);font-size:12px">—</div>
      </div>
    </div>

    <div class="center">
      <audio id="player" controls style="width:520px; max-width:60vw; background:transparent"></audio>
    </div>

    <div class="right">
      <div style="color:var(--muted);font-size:13px">Velocidad</div>
      <input id="speed" type="range" min="0.5" max="2.0" step="0.1" value="1" oninput="setSpeed(this.value)" aria-label="playback speed">
      <div id="speedVal" style="min-width:36px;text-align:right">1.0</div>
    </div>
  </div>

  <script>
    let user_type = 'guest';

    function doLogin() {
      const u = document.getElementById('u').value;
      const p = document.getElementById('p').value;
      if (u === 'admin' && p === '1234') {
        user_type = 'admin';
        document.getElementById('login-res').innerText = 'Logged as admin';
      } else {
        document.getElementById('login-res').innerText = 'Login failed';
      }
      loadBackups();
    }

    function loadSongs() {
      fetch('/api/songs')
        .then(r => r.json())
        .then(drawSongs)
        .catch(e => { document.getElementById('songs').innerText = 'Error cargando'; });
    }

    function loadBackups() {
      fetch('/api/songs_backup')
        .then(r => r.json())
        .then(drawBackups)
        .catch(e => { document.getElementById('backups').innerText = 'Error cargando backups'; });
    }

    function drawSongs(list) {
      const container = document.getElementById('songs');
      container.innerHTML = '';
      list.forEach(s => {
        const d = document.createElement('div');
        d.className = 'song';
        d.innerHTML = `
          <div class="art">♪</div>
          <div class="meta">
            <div class="title">${escapeHtml(s.title)}</div>
            <div class="artist">${escapeHtml(s.artist)}</div>
          </div>
          <div class="controls">
            <button class="playbtn" onclick="play(${s.id})">Play</button>
            <button class="backupbtn" onclick="backup(${s.id})">Backup</button>
          </div>`;
        container.appendChild(d);
      });
    }

    function drawBackups(list) {
      const container = document.getElementById('backups');
      container.innerHTML = '';
      if (!list.length) {
        container.innerText = 'No backups';
        return;
      }
      list.forEach(b => {
        const d = document.createElement('div');
        d.className = 'song';
        d.innerHTML = `
          <div class="art">⌁</div>
          <div class="meta">
            <div class="title">[B${b.id}] ${escapeHtml(b.title)}</div>
            <div class="artist">by ${escapeHtml(b.backed_up_by)} at ${escapeHtml(b.backed_up_at)}</div>
          </div>
          <div class="controls">
            <button class="playbtn" onclick="playBackup(${b.id})">Play</button>
          </div>`;
        container.appendChild(d);
      });
    }

    function play(id) {
      if (user_type == 'admin') {
        console.log('Admin is playing');
      }
      const audio = document.getElementById('player');
      audio.src = '/play/' + id;
      // actualizar info sencilla
      document.getElementById('now-title').innerText = 'Reproduciendo #' + id;
      document.getElementById('now-artist').innerText = '';
      // aplicar velocidad actual
      const speed = parseFloat(document.getElementById('speed').value);
      audio.playbackRate = speed;
      document.getElementById('speedVal').innerText = speed.toFixed(1);
      audio.play().catch(e => console.log('Play err', e));
    }

    function playBackup(id) {
      const audio = document.getElementById('player');
      audio.src = '/play_backup/' + id;
      const speed = parseFloat(document.getElementById('speed').value);
      audio.playbackRate = speed;
      document.getElementById('speedVal').innerText = speed.toFixed(1);
      document.getElementById('now-title').innerText = 'Backup #' + id;
      document.getElementById('now-artist').innerText = '';
      audio.play().catch(e => console.log('Play backup err', e));
    }

    function backup(id) {
      const form = new FormData();
      form.append('backed_by', user_type);
      form.append('note', 'manual backup from UI');
      fetch('/api/backup/' + id, { method: 'POST', body: form })
        .then(r => r.json())
        .then(j => {
          if (j.ok) {
            alert('Backup created: ' + j.backup_id);
            loadBackups();
          } else {
            alert('Backup failed: ' + (j.error || 'unknown'));
          }
        })
        .catch(e => alert('Backup error'));
    }

    function setSpeed(v) {
      // mantener el valor en todas las barras (hay dos inputs con id speed para diseño responsive)
      const speeds = document.querySelectorAll('#speed');
      speeds.forEach(s => { s.value = v; });
      document.getElementById('speedVal').innerText = parseFloat(v).toFixed(1);
      const audio = document.getElementById('player');
      audio.playbackRate = parseFloat(v);
    }

    // util escape básico para evitar inyección de HTML en la UI
    function escapeHtml(str){
      if (!str && str !== 0) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function(s) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s];
      });
    }

    // carga inicial
    loadSongs();
    loadBackups();
  </script>
</body>
</html>